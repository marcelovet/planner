<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./assets/js/tailwind.js"></script>
    <style>
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body
    class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors"
  >
    <div class="min-h-screen">
      <!-- Header -->
      <header
        class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700"
      >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center space-x-3">
              <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                  Controle de Estudos
                </h1>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <button
                id="exportDataBtn"
                class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                title="Exportar dados"
              >
                üì•
              </button>
              <button
                id="importDataBtn"
                class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                title="Importar dados"
              >
                üì§
              </button>
              <button
                id="clearDataBtn"
                class="p-2 rounded-lg bg-red-100 dark:bg-red-900/20 hover:bg-red-200 dark:hover:bg-red-900/40 transition-colors"
                title="Limpar todos os dados"
              >
                üóëÔ∏è
              </button>
              <button
                id="darkModeToggle"
                class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
              >
                <span class="dark:hidden">üåô</span>
                <span class="hidden dark:inline">‚òÄÔ∏è</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Hidden file input for import -->
      <input
        type="file"
        id="importFileInput"
        accept=".json"
        style="display: none"
      />

      <!-- Navigation -->
      <nav
        class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700"
      >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex space-x-8 overflow-x-auto">
            <button
              class="nav-tab py-4 px-2 border-b-2 border-primary text-primary font-medium whitespace-nowrap"
              data-tab="dashboard"
            >
              Dashboard
            </button>
            <button
              class="nav-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 font-medium whitespace-nowrap"
              data-tab="tempo"
            >
              C√°lculo de Tempo
            </button>
            <button
              class="nav-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 font-medium whitespace-nowrap"
              data-tab="desempenho"
            >
              Desempenho
            </button>
            <button
              class="nav-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 font-medium whitespace-nowrap"
              data-tab="cronograma"
            >
              Cronograma
            </button>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          >
            <!-- Cards de Resumo -->
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
            >
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div
                    class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center"
                  >
                    <span class="text-blue-600 dark:text-blue-400">üìö</span>
                  </div>
                </div>
                <div class="ml-4">
                  <p
                    class="text-sm font-medium text-gray-500 dark:text-gray-400"
                  >
                    Tempo Total Estimado
                  </p>
                  <p
                    class="text-2xl font-semibold text-gray-900 dark:text-white"
                    id="tempoTotal"
                  >
                    0h
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
            >
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div
                    class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center"
                  >
                    <span class="text-green-600 dark:text-green-400">üìä</span>
                  </div>
                </div>
                <div class="ml-4">
                  <p
                    class="text-sm font-medium text-gray-500 dark:text-gray-400"
                  >
                    Desempenho M√©dio
                  </p>
                  <p
                    class="text-2xl font-semibold text-gray-900 dark:text-white"
                    id="desempenhoMedio"
                  >
                    0%
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
            >
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div
                    class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center"
                  >
                    <span class="text-yellow-600 dark:text-yellow-400">üìÖ</span>
                  </div>
                </div>
                <div class="ml-4">
                  <p
                    class="text-sm font-medium text-gray-500 dark:text-gray-400"
                  >
                    Semanas de Estudo
                  </p>
                  <p
                    class="text-2xl font-semibold text-gray-900 dark:text-white"
                    id="semanasEstudo"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
            >
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div
                    class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center"
                  >
                    <span class="text-purple-600 dark:text-purple-400">üéØ</span>
                  </div>
                </div>
                <div class="ml-4">
                  <p
                    class="text-sm font-medium text-gray-500 dark:text-gray-400"
                  >
                    Quest√µes Feitas
                  </p>
                  <p
                    class="text-2xl font-semibold text-gray-900 dark:text-white"
                    id="questoesFeitas"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Gr√°ficos -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
            >
              <h3 class="text-lg font-semibold mb-4">
                Distribui√ß√£o do Tempo por Mat√©ria
              </h3>
              <canvas id="tempoChart" class="max-h-80"></canvas>
            </div>
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
            >
              <h3 class="text-lg font-semibold mb-4">Desempenho por Mat√©ria</h3>
              <canvas id="desempenhoChart" class="max-h-80"></canvas>
            </div>
          </div>
        </div>

        <!-- C√°lculo de Tempo Tab -->
        <div id="tempo" class="tab-content hidden">
          <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
          >
            <h2 class="text-2xl font-bold mb-6">
              C√°lculo do Tempo para o Edital
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Carga Hor√°ria de Estudo por Aula/PDF/VA (h)</label
                >
                <input
                  type="number"
                  id="chPorAula"
                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"
                  value="6"
                  step="0.5"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Carga Hor√°ria por Dia (h)</label
                >
                <input
                  type="number"
                  id="chPorDia"
                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"
                  value="6"
                  step="0.5"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Dias de Estudo por M√™s</label
                >
                <input
                  type="number"
                  id="diasPorMes"
                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"
                  value="26"
                />
              </div>
            </div>

            <div class="mb-4 flex justify-between items-center">
              <h3 class="text-lg font-semibold">Disciplinas</h3>
              <button
                id="addMateria"
                class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors"
              >
                + Adicionar Disciplina
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-700">
                    <th class="text-left p-3 font-semibold">Mat√©ria</th>
                    <th class="text-center p-3 font-semibold">Qtd PDFs/VA</th>
                    <th class="text-center p-3 font-semibold">
                      CH por Mat√©ria (h)
                    </th>
                    <th class="text-center p-3 font-semibold">Peso no Ciclo</th>
                    <th class="text-center p-3 font-semibold">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="materiasTabela">
                  <!-- Mat√©rias ser√£o inseridas dinamicamente -->
                </tbody>
              </table>
            </div>

            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-900 dark:text-blue-300">
                  Primeira Leitura
                </h4>
                <p
                  class="text-2xl font-bold text-blue-600 dark:text-blue-400"
                  id="primeiraLeitura"
                >
                  0h
                </p>
              </div>
              <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-green-900 dark:text-green-300">
                  Revis√µes
                </h4>
                <p
                  class="text-2xl font-bold text-green-600 dark:text-green-400"
                  id="revisoes"
                >
                  0h
                </p>
              </div>
              <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-purple-900 dark:text-purple-300">
                  Total para o Edital
                </h4>
                <p
                  class="text-2xl font-bold text-purple-600 dark:text-purple-400"
                  id="totalEdital"
                >
                  0h
                </p>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
              <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold mb-2">Dias para estudar tudo:</h4>
                <p class="text-lg font-bold" id="diasTotal">0 dias</p>
              </div>
              <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold mb-2">Meses necess√°rios:</h4>
                <p class="text-lg font-bold" id="mesesTotal">0 meses</p>
              </div>
              <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold mb-2">Semanas necess√°rias:</h4>
                <p class="text-lg font-bold" id="semanasTotal">0 semanas</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Desempenho Tab -->
        <div id="desempenho" class="tab-content hidden">
          <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
          >
            <h2 class="text-2xl font-bold mb-6">Controle de Desempenho</h2>

            <div
              class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"
              id="desempenhoCards"
            >
              <!-- Cards de desempenho ser√£o inseridos dinamicamente -->
            </div>
          </div>
        </div>

        <!-- Cronograma Tab -->
        <div id="cronograma" class="tab-content hidden">
          <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700"
          >
            <h2 class="text-2xl font-bold mb-6">Cronograma de Estudos</h2>

            <div class="mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2"
                    >Semana Atual</label
                  >
                  <select
                    id="semanaAtual"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"
                  >
                    <option value="1">Semana 1</option>
                    <option value="2">Semana 2</option>
                    <option value="3">Semana 3</option>
                    <option value="4">Semana 4</option>
                    <option value="5">Semana 5</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="cronogramaContent">
              <!-- Cronograma ser√° inserido dinamicamente -->
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Storage Manager - Handles all data persistence
      const StorageManager = {
        STORAGE_KEYS: {
          MATERIAS: 'controleEstudos_materias',
          PERFORMANCE: 'controleEstudos_performance',
          CRONOGRAMA: 'controleEstudos_cronograma',
          SETTINGS: 'controleEstudos_settings',
          DARK_MODE: 'controleEstudos_darkMode',
        },

        // Save data to localStorage
        save(key, data) {
          try {
            localStorage.setItem(key, JSON.stringify(data));
            return true;
          } catch (error) {
            console.error('Error saving to localStorage:', error);
            return false;
          }
        },

        // Load data from localStorage
        load(key) {
          try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
          } catch (error) {
            console.error('Error loading from localStorage:', error);
            return null;
          }
        },

        // Save all app data
        saveAllData() {
          this.save(this.STORAGE_KEYS.MATERIAS, materias);
          this.save(this.STORAGE_KEYS.PERFORMANCE, performanceData);
          this.save(this.STORAGE_KEYS.CRONOGRAMA, cronogramaSemanal);

          const settings = {
            chPorAula: document.getElementById('chPorAula')?.value || 6,
            chPorDia: document.getElementById('chPorDia')?.value || 6,
            diasPorMes: document.getElementById('diasPorMes')?.value || 26,
          };
          this.save(this.STORAGE_KEYS.SETTINGS, settings);
        },

        // Load all app data
        loadAllData() {
          const savedMaterias = this.load(this.STORAGE_KEYS.MATERIAS);
          const savedPerformance = this.load(this.STORAGE_KEYS.PERFORMANCE);
          const savedCronograma = this.load(this.STORAGE_KEYS.CRONOGRAMA);
          const savedSettings = this.load(this.STORAGE_KEYS.SETTINGS);
          const savedDarkMode = this.load(this.STORAGE_KEYS.DARK_MODE);

          if (savedMaterias && savedMaterias.length > 0) {
            materias.length = 0;
            materias.push(...savedMaterias);
          }

          if (savedPerformance) {
            Object.assign(performanceData, savedPerformance);
          }

          if (savedCronograma) {
            Object.assign(cronogramaSemanal, savedCronograma);
          }

          if (savedSettings) {
            if (document.getElementById('chPorAula')) {
              document.getElementById('chPorAula').value =
                savedSettings.chPorAula;
            }
            if (document.getElementById('chPorDia')) {
              document.getElementById('chPorDia').value =
                savedSettings.chPorDia;
            }
            if (document.getElementById('diasPorMes')) {
              document.getElementById('diasPorMes').value =
                savedSettings.diasPorMes;
            }
          }

          if (savedDarkMode !== null) {
            if (savedDarkMode) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          }
        },

        // Export all data as JSON
        exportData() {
          const exportData = {
            version: '1.0',
            date: new Date().toISOString(),
            materias: materias,
            performance: performanceData,
            cronograma: cronogramaSemanal,
            settings: {
              chPorAula: document.getElementById('chPorAula')?.value || 6,
              chPorDia: document.getElementById('chPorDia')?.value || 6,
              diasPorMes: document.getElementById('diasPorMes')?.value || 26,
            },
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: 'application/json',
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `controle-estudos-${
            new Date().toISOString().split('T')[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        },

        // Import data from JSON file
        importData(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);

              if (importedData.materias) {
                materias.length = 0;
                materias.push(...importedData.materias);
              }

              if (importedData.performance) {
                Object.keys(performanceData).forEach(
                  (key) => delete performanceData[key]
                );
                Object.assign(performanceData, importedData.performance);
              }

              if (importedData.cronograma) {
                Object.keys(cronogramaSemanal).forEach(
                  (key) => delete cronogramaSemanal[key]
                );
                Object.assign(cronogramaSemanal, importedData.cronograma);
              }

              if (importedData.settings) {
                if (document.getElementById('chPorAula')) {
                  document.getElementById('chPorAula').value =
                    importedData.settings.chPorAula;
                }
                if (document.getElementById('chPorDia')) {
                  document.getElementById('chPorDia').value =
                    importedData.settings.chPorDia;
                }
                if (document.getElementById('diasPorMes')) {
                  document.getElementById('diasPorMes').value =
                    importedData.settings.diasPorMes;
                }
              }

              this.saveAllData();

              // Refresh all views
              initDashboard();
              initTempoTab();
              initDesempenhoTab();
              initCronogramaTab();

              alert('Dados importados com sucesso!');
            } catch (error) {
              console.error('Error importing data:', error);
              alert('Erro ao importar dados. Verifique se o arquivo √© v√°lido.');
            }
          };
          reader.readAsText(file);
        },

        // Clear all data
        clearAllData() {
          if (
            confirm(
              'Tem certeza que deseja limpar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita.'
            )
          ) {
            Object.keys(this.STORAGE_KEYS).forEach((key) => {
              localStorage.removeItem(this.STORAGE_KEYS[key]);
            });

            materias.length = 0;
            Object.keys(performanceData).forEach(
              (key) => delete performanceData[key]
            );
            Object.keys(cronogramaSemanal).forEach(
              (key) => delete cronogramaSemanal[key]
            );

            document.getElementById('chPorAula').value = 6;
            document.getElementById('chPorDia').value = 6;
            document.getElementById('diasPorMes').value = 26;

            // Refresh all views
            initDashboard();
            initTempoTab();
            initDesempenhoTab();
            initCronogramaTab();

            alert('Todos os dados foram limpos!');
          }
        },
      };

      // Global variables
      let materias = [];
      let performanceData = {};
      let cronogramaSemanal = {};
      let chartInstances = {
        tempoChart: null,
        desempenhoChart: null,
      };

      // Auto-save functionality
      function setupAutoSave() {
        // Save data whenever it changes
        const saveData = () => StorageManager.saveAllData();

        // Add event listeners to all inputs
        document.addEventListener('input', (e) => {
          if (e.target.matches('input, select, textarea')) {
            saveData();
          }
        });

        // Save on specific events
        window.addEventListener('beforeunload', saveData);
      }

      // Dark mode toggle
      function initDarkMode() {
        const savedDarkMode = StorageManager.load(
          StorageManager.STORAGE_KEYS.DARK_MODE
        );

        if (savedDarkMode === null) {
          if (
            window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches
          ) {
            document.documentElement.classList.add('dark');
          }
        } else if (savedDarkMode) {
          document.documentElement.classList.add('dark');
        }

        window
          .matchMedia('(prefers-color-scheme: dark)')
          .addEventListener('change', (event) => {
            if (event.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          });

        document
          .getElementById('darkModeToggle')
          .addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            StorageManager.save(StorageManager.STORAGE_KEYS.DARK_MODE, isDark);
          });
      }

      // Tab navigation
      function initTabs() {
        const tabButtons = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');

            tabButtons.forEach((btn) => {
              btn.classList.remove('border-primary', 'text-primary');
              btn.classList.add(
                'border-transparent',
                'text-gray-500',
                'hover:text-gray-700',
                'dark:text-gray-400',
                'dark:hover:text-gray-300'
              );
            });

            button.classList.add('border-primary', 'text-primary');
            button.classList.remove(
              'border-transparent',
              'text-gray-500',
              'hover:text-gray-700',
              'dark:text-gray-400',
              'dark:hover:text-gray-300'
            );

            tabContents.forEach((content) => {
              content.classList.add('hidden');
            });

            document.getElementById(targetTab).classList.remove('hidden');
            document.getElementById(targetTab).classList.add('fade-in');

            if (targetTab === 'dashboard') {
              initDashboard();
            } else if (targetTab === 'tempo') {
              initTempoTab();
            } else if (targetTab === 'desempenho') {
              initDesempenhoTab();
            } else if (targetTab === 'cronograma') {
              initCronogramaTab();
            }
          });
        });
      }

      // Dashboard functions
      function initDashboard() {
        updateDashboardCards();
        initCharts();
      }

      function updateDashboardCards() {
        const chPorAula = parseFloat(
          document.getElementById('chPorAula')?.value || 6
        );
        const totalPdfs = materias.reduce((sum, m) => sum + m.pdfs, 0);
        const tempoTotal = totalPdfs * chPorAula * 1.5;

        const questoesTotal = Object.values(performanceData).reduce(
          (sum, p) => sum + p.questoes,
          0
        );
        const acertosTotal = Object.values(performanceData).reduce(
          (sum, p) => sum + p.acertos,
          0
        );
        const desempenhoMedio =
          questoesTotal > 0
            ? ((acertosTotal / questoesTotal) * 100).toFixed(1)
            : 0;

        document.getElementById(
          'tempoTotal'
        ).textContent = `${tempoTotal.toFixed(0)}h`;
        document.getElementById(
          'desempenhoMedio'
        ).textContent = `${desempenhoMedio}%`;
        document.getElementById('semanasEstudo').textContent = Math.ceil(
          tempoTotal / 42
        );
        document.getElementById('questoesFeitas').textContent = questoesTotal;
      }

      function initCharts() {
        const chPorAula = parseFloat(
          document.getElementById('chPorAula')?.value || 6
        );
        const materiasSorted = [...materias].sort(
          (a, b) => b.pdfs * chPorAula - a.pdfs * chPorAula
        );

        const ctx1 = document.getElementById('tempoChart');
        if (ctx1) {
          if (chartInstances.tempoChart) {
            chartInstances.tempoChart.data.labels = materiasSorted
              .slice(0, 8)
              .map((m) => m.nome);
            chartInstances.tempoChart.data.datasets[0].data = materiasSorted
              .slice(0, 8)
              .map((m) => m.pdfs * chPorAula);
            chartInstances.tempoChart.update();
          } else {
            chartInstances.tempoChart = new Chart(ctx1, {
              type: 'doughnut',
              data: {
                labels: materiasSorted.slice(0, 8).map((m) => m.nome),
                datasets: [
                  {
                    data: materiasSorted
                      .slice(0, 8)
                      .map((m) => m.pdfs * chPorAula),
                    backgroundColor: [
                      '#FF6384',
                      '#36A2EB',
                      '#FFCE56',
                      '#4BC0C0',
                      '#9966FF',
                      '#FF9F40',
                      '#FF6384',
                      '#C9CBCF',
                    ],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                  },
                },
              },
            });
          }
        }

        const ctx2 = document.getElementById('desempenhoChart');
        if (ctx2) {
          if (chartInstances.desempenhoChart) {
            chartInstances.desempenhoChart.data.labels = materiasSorted
              .slice(0, 8)
              .map((m) => m.nome.split(' ')[0]);
            chartInstances.desempenhoChart.data.datasets[0].data =
              materiasSorted
                .slice(0, 8)
                .map(
                  (m) =>
                    (performanceData[m.nome] || { desempenho: 0 }).desempenho
                );
            chartInstances.desempenhoChart.update();
          } else {
            chartInstances.desempenhoChart = new Chart(ctx2, {
              type: 'bar',
              data: {
                labels: materiasSorted
                  .slice(0, 8)
                  .map((m) => m.nome.split(' ')[0]),
                datasets: [
                  {
                    label: 'Desempenho (%)',
                    data: materiasSorted
                      .slice(0, 8)
                      .map(
                        (m) =>
                          (performanceData[m.nome] || { desempenho: 0 })
                            .desempenho
                      ),
                    backgroundColor: '#5D5CDE',
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100,
                  },
                },
              },
            });
          }
        }
      }

      // Subject management functions
      function addMateria() {
        const novaMateria = {
          nome: 'Nova Disciplina',
          pdfs: 1,
          peso: 1,
        };

        materias.push(novaMateria);

        performanceData[novaMateria.nome] = {
          aulas: 0,
          questoes: 0,
          acertos: 0,
          desempenho: 0,
        };

        StorageManager.saveAllData();
        renderMaterias();
        updateDashboardCards();
      }

      function removeMateria(index) {
        if (materias.length <= 1) {
          alert('Deve haver pelo menos uma disciplina!');
          return;
        }

        const materia = materias[index];
        if (confirm(`Tem certeza que deseja remover "${materia.nome}"?`)) {
          delete performanceData[materia.nome];
          materias.splice(index, 1);
          StorageManager.saveAllData();
          renderMaterias();
          updateDashboardCards();
          initDesempenhoTab();
        }
      }

      function updateMateria(index, field, value) {
        const oldName = materias[index].nome;

        if (field === 'nome') {
          materias[index][field] = value;
          if (performanceData[oldName] && value !== oldName) {
            performanceData[value] = performanceData[oldName];
            delete performanceData[oldName];
          }
        } else {
          materias[index][field] = parseFloat(value) || 0;
        }

        StorageManager.saveAllData();
        renderMaterias();
        updateDashboardCards();
      }

      // Time tab functions
      function initTempoTab() {
        const tabela = document.getElementById('materiasTabela');
        if (!tabela) return;

        renderMaterias();
        setupAddMateriaButton();

        ['chPorAula', 'chPorDia', 'diasPorMes'].forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('input', () => {
              renderMaterias();
              StorageManager.saveAllData();
            });
          }
        });
      }

      function setupAddMateriaButton() {
        const addButton = document.getElementById('addMateria');
        if (addButton && !addButton.hasAttribute('data-listener')) {
          addButton.setAttribute('data-listener', 'true');
          addButton.addEventListener('click', addMateria);
        }
      }

      function renderMaterias() {
        const tabela = document.getElementById('materiasTabela');
        if (!tabela) return;

        tabela.innerHTML = '';
        let totalPdfs = 0;
        let totalCH = 0;

        materias.forEach((materia, index) => {
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-200 dark:border-gray-700';

          const chPorAula = parseFloat(
            document.getElementById('chPorAula').value || 6
          );
          const chMateria = materia.pdfs * chPorAula;

          totalPdfs += materia.pdfs;
          totalCH += chMateria;

          row.innerHTML = `
            <td class="p-3">
              <input type="text" value="${materia.nome}"
                     class="w-full bg-transparent border-none p-0 font-medium text-base focus:outline-none focus:ring-2 focus:ring-primary rounded px-2 py-1"
                     onchange="updateMateria(${index}, 'nome', this.value)">
            </td>
            <td class="p-3 text-center">
              <input type="number" value="${materia.pdfs}"
                     class="w-20 text-center bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-base focus:outline-none focus:ring-2 focus:ring-primary"
                     onchange="updateMateria(${index}, 'pdfs', this.value)">
            </td>
            <td class="p-3 text-center font-medium">${chMateria.toFixed(
              1
            )}h</td>
            <td class="p-3 text-center">
              <input type="number" value="${materia.peso}"
                     class="w-16 text-center bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-base focus:outline-none focus:ring-2 focus:ring-primary"
                     onchange="updateMateria(${index}, 'peso', this.value)">
            </td>
            <td class="p-3 text-center">
              <button onclick="removeMateria(${index})"
                      class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                üóëÔ∏è
              </button>
            </td>
          `;
          tabela.appendChild(row);
        });

        updateTotals(totalCH);
      }

      function updateTotals(totalCH) {
        const chPorDia = parseFloat(
          document.getElementById('chPorDia').value || 6
        );
        const diasPorMes = parseFloat(
          document.getElementById('diasPorMes').value || 26
        );

        const primeiraLeitura = totalCH;
        const revisoes = totalCH / 2;
        const total = primeiraLeitura + revisoes;

        document.getElementById(
          'primeiraLeitura'
        ).textContent = `${primeiraLeitura.toFixed(0)}h`;
        document.getElementById('revisoes').textContent = `${revisoes.toFixed(
          0
        )}h`;
        document.getElementById('totalEdital').textContent = `${total.toFixed(
          0
        )}h`;

        const diasTotal = Math.ceil(total / chPorDia);
        const mesesTotal = Math.ceil(diasTotal / diasPorMes);
        const semanasTotal = Math.ceil(diasTotal / 7);

        document.getElementById('diasTotal').textContent = `${diasTotal} dias`;
        document.getElementById(
          'mesesTotal'
        ).textContent = `${mesesTotal.toFixed(1)} meses`;
        document.getElementById(
          'semanasTotal'
        ).textContent = `${semanasTotal} semanas`;
      }

      // Performance tab functions
      function initDesempenhoTab() {
        const container = document.getElementById('desempenhoCards');
        if (!container) return;

        container.innerHTML = '';

        materias.forEach((materia) => {
          const data = performanceData[materia.nome] || {
            aulas: 0,
            questoes: 0,
            acertos: 0,
            desempenho: 0,
          };

          const card = document.createElement('div');
          card.className =
            'bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4';

          card.innerHTML = `
            <h4 class="font-semibold mb-3 text-sm">${materia.nome}</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Aulas:</span>
                <input type="number" value="${
                  data.aulas
                }" class="w-16 text-right bg-transparent border-none p-0 text-sm" onchange="updatePerformance('${
            materia.nome
          }', 'aulas', this.value)">
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Quest√µes:</span>
                <input type="number" value="${
                  data.questoes
                }" class="w-16 text-right bg-transparent border-none p-0 text-sm" onchange="updatePerformance('${
            materia.nome
          }', 'questoes', this.value)">
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Acertos:</span>
                <input type="number" value="${
                  data.acertos
                }" class="w-16 text-right bg-transparent border-none p-0 text-sm" onchange="updatePerformance('${
            materia.nome
          }', 'acertos', this.value)">
              </div>
              <div class="flex justify-between font-semibold pt-2 border-t border-gray-200 dark:border-gray-600">
                <span>Desempenho:</span>
                <span class="text-primary">${data.desempenho.toFixed(1)}%</span>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function updatePerformance(materia, field, value) {
        if (!performanceData[materia]) {
          performanceData[materia] = {
            aulas: 0,
            questoes: 0,
            acertos: 0,
            desempenho: 0,
          };
        }

        performanceData[materia][field] = parseInt(value) || 0;

        const data = performanceData[materia];
        data.desempenho =
          data.questoes > 0 ? (data.acertos / data.questoes) * 100 : 0;

        StorageManager.saveAllData();
        initDesempenhoTab();
        updateDashboardCards();
      }

      // Schedule tab functions
      function getSemanasNecessarias() {
        const tempoTotal = materias.reduce(
          (sum, m) =>
            sum +
            m.pdfs *
              parseFloat(document.getElementById('chPorAula')?.value || 6) *
              1.5,
          0
        );
        const chPorDia = parseFloat(
          document.getElementById('chPorDia')?.value || 6
        );
        const diasTotal = Math.ceil(tempoTotal / chPorDia);
        return Math.ceil(diasTotal / 7);
      }

      function initCronogramaTab() {
        const container = document.getElementById('cronogramaContent');
        if (!container) return;

        updateSemanaOptions();

        const semana = parseInt(document.getElementById('semanaAtual').value);

        if (!cronogramaSemanal[semana]) {
          cronogramaSemanal[semana] = {
            segunda: [],
            terca: [],
            quarta: [],
            quinta: [],
            sexta: [],
            sabado: [],
            domingo: [],
          };
        }

        renderCronograma(semana);
      }

      function updateSemanaOptions() {
        const select = document.getElementById('semanaAtual');
        const semanasNecessarias = getSemanasNecessarias();

        const valorAnterior = select.value;
        select.innerHTML = '';

        for (let i = 1; i <= semanasNecessarias; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `Semana ${i}`;

          if (valorAnterior && parseInt(valorAnterior) === i) {
            option.selected = true;
          } else if (!valorAnterior && i === 1) {
            option.selected = true;
          }
          select.appendChild(option);
        }
      }

      function renderCronograma(semana) {
        const container = document.getElementById('cronogramaContent');
        const diasSemana = [
          'segunda',
          'terca',
          'quarta',
          'quinta',
          'sexta',
          'sabado',
          'domingo',
        ];
        const nomesDias = [
          'Segunda',
          'Ter√ßa',
          'Quarta',
          'Quinta',
          'Sexta',
          'S√°bado',
          'Domingo',
        ];

        let html = `
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-blue-900 dark:text-blue-300 mb-2">Semana ${semana}</h3>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
        `;

        diasSemana.forEach((dia, index) => {
          html += `
            <div class="space-y-3">
              <div class="text-center">
                <h4 class="font-semibold">${nomesDias[index]}</h4>
              </div>
          `;

          const disciplinasDia = cronogramaSemanal[semana][dia] || [];

          disciplinasDia.forEach((disc, discIndex) => {
            html += `
              <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-sm relative group">
                <button onclick="removeDisciplinaDia(${semana}, '${dia}', ${discIndex})"
                        class="absolute top-1 right-1 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-xs">
                  ‚úï
                </button>
                <p class="font-medium pr-4">${disc.nome}</p>
                <div class="flex items-center mt-1">
                  <input type="number"
                          value="${disc.horas}"
                          min="0.5"
                          max="12"
                          step="0.5"
                          class="w-16 text-xs bg-transparent border border-gray-300 dark:border-gray-600 rounded px-1 py-0.5"
                          onchange="updateHorasDisciplina(${semana}, '${dia}', ${discIndex}, this.value)">
                  <span class="text-gray-600 dark:text-gray-400 ml-1">h</span>
                </div>
              </div>
            `;
          });

          html += `
            <button onclick="showAddDisciplinaModal(${semana}, '${dia}')"
                    class="w-full p-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded text-sm text-gray-500 dark:text-gray-400 hover:border-primary hover:text-primary transition-colors">
              + Adicionar
            </button>
          </div>
          `;
        });

        html += `</div>`;
        html += renderResumoSemana(semana);

        container.innerHTML = html;
        setupCronogramaListeners();
      }

      function renderResumoSemana(semana) {
        const diasSemana = [
          'segunda',
          'terca',
          'quarta',
          'quinta',
          'sexta',
          'sabado',
        ];
        let totalHoras = 0;
        let disciplinasHoras = {};

        diasSemana.forEach((dia) => {
          const disciplinas = cronogramaSemanal[semana][dia] || [];
          disciplinas.forEach((disc) => {
            totalHoras += disc.horas;
            if (!disciplinasHoras[disc.nome]) {
              disciplinasHoras[disc.nome] = 0;
            }
            disciplinasHoras[disc.nome] += disc.horas;
          });
        });

        let html = `
          <div class="mt-8 bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
            <h4 class="font-semibold mb-4">Resumo da Semana ${semana}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Total de horas planejadas:</p>
                <p class="text-2xl font-bold text-primary">${totalHoras.toFixed(
                  1
                )}h</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Distribui√ß√£o por disciplina:</p>
                <div class="space-y-1">
        `;

        Object.entries(disciplinasHoras).forEach(([nome, horas]) => {
          const percentual =
            totalHoras > 0 ? ((horas / totalHoras) * 100).toFixed(1) : 0;
          html += `
            <div class="flex justify-between text-sm">
              <span>${nome}:</span>
              <span class="font-medium">${horas.toFixed(
                1
              )}h (${percentual}%)</span>
            </div>
          `;
        });

        html += `
              </div>
            </div>
          </div>
        </div>
        `;

        return html;
      }

      function showAddDisciplinaModal(semana, dia) {
        const existingModal = document.getElementById('addDisciplinaModal');
        if (existingModal) {
          existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.id = 'addDisciplinaModal';
        modal.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

        let optionsHtml = '';
        materias.forEach((materia) => {
          optionsHtml += `
            <label class="flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded cursor-pointer">
              <input type="checkbox" value="${materia.nome}" class="mr-3">
              <span>${materia.nome}</span>
            </label>
          `;
        });

        modal.innerHTML = `
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 max-h-[80vh] flex flex-col">
            <h3 class="text-lg font-semibold mb-4">Adicionar Disciplinas</h3>
            <div class="flex-1 overflow-y-auto mb-4">
              <div class="space-y-1">
                ${optionsHtml}
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">Horas por disciplina:</label>
              <input type="number"
                     id="horasPorDisciplina"
                     value="1.5"
                     min="0.5"
                     max="8"
                     step="0.5"
                     class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
            </div>
            <div class="flex justify-end space-x-3">
              <button onclick="closeAddDisciplinaModal()"
                      class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Cancelar
              </button>
              <button onclick="addDisciplinasSelecionadas(${semana}, '${dia}')"
                      class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
                Adicionar
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeAddDisciplinaModal();
          }
        });
      }

      function closeAddDisciplinaModal() {
        const modal = document.getElementById('addDisciplinaModal');
        if (modal) {
          modal.remove();
        }
      }

      function addDisciplinasSelecionadas(semana, dia) {
        const modal = document.getElementById('addDisciplinaModal');
        const checkboxes = modal.querySelectorAll(
          'input[type="checkbox"]:checked'
        );
        const horas =
          parseFloat(document.getElementById('horasPorDisciplina').value) ||
          1.5;

        checkboxes.forEach((checkbox) => {
          cronogramaSemanal[semana][dia].push({
            nome: checkbox.value,
            horas: horas,
          });
        });

        StorageManager.saveAllData();
        closeAddDisciplinaModal();
        renderCronograma(semana);
      }

      function removeDisciplinaDia(semana, dia, index) {
        cronogramaSemanal[semana][dia].splice(index, 1);
        StorageManager.saveAllData();
        renderCronograma(semana);
      }

      function updateHorasDisciplina(semana, dia, index, horas) {
        cronogramaSemanal[semana][dia][index].horas = parseFloat(horas) || 0;
        StorageManager.saveAllData();
        renderCronograma(semana);
      }

      function setupCronogramaListeners() {
        const semanaSelect = document.getElementById('semanaAtual');
        semanaSelect.removeEventListener('change', initCronogramaTab);
        semanaSelect.addEventListener('change', initCronogramaTab);
      }

      // Initialize app
      document.addEventListener('DOMContentLoaded', () => {
        // Load saved data first
        StorageManager.loadAllData();

        // Initialize dark mode
        initDarkMode();

        // Initialize tabs
        initTabs();

        // Initialize components
        initDashboard();
        initTempoTab();
        initDesempenhoTab();
        initCronogramaTab();

        // Setup auto-save
        setupAutoSave();

        // Setup export/import buttons
        document
          .getElementById('exportDataBtn')
          .addEventListener('click', () => {
            StorageManager.exportData();
          });

        document
          .getElementById('importDataBtn')
          .addEventListener('click', () => {
            document.getElementById('importFileInput').click();
          });

        document
          .getElementById('importFileInput')
          .addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              StorageManager.importData(file);
              e.target.value = ''; // Reset input
            }
          });

        document
          .getElementById('clearDataBtn')
          .addEventListener('click', () => {
            StorageManager.clearAllData();
          });
      });
    </script>
  </body>
</html>
